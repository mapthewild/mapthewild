---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import Breadcrumbs from '../../components/Breadcrumbs.astro'

const islandMeta: Record<string, { name: string; description: string; dedicatedPage?: boolean }> = {
  nowbrary: {
    name: 'Nowbrary',
    description: 'Living constellation of books'
  },
  map: {
    name: 'Map',
    description: 'Working things out — exploratory, unformed, questioning'
  },
  territory: {
    name: 'Territory',
    description: 'Developed work — established, complete, structured'
  },
  sundayritual: {
    name: 'Sunday Ritual',
    description: 'Weekly practice for reflection and intention',
    dedicatedPage: true
  }
}

const posts = await getCollection('posts')
const publishedPosts = posts.filter(post => !post.data.draft)

// Count posts per island
const islandCounts: Record<string, number> = {}
publishedPosts.forEach(post => {
  post.data.islands?.forEach(island => {
    islandCounts[island] = (islandCounts[island] || 0) + 1
  })
})

// Get islands that have posts, ordered by count
const postBasedIslands = Object.entries(islandCounts)
  .sort((a, b) => b[1] - a[1])
  .map(([id, count]) => ({
    id,
    count,
    ...islandMeta[id] || { name: id, description: '' }
  }))

// Add dedicated territory pages (like Sunday Ritual) that aren't post collections
const dedicatedIslands = Object.entries(islandMeta)
  .filter(([id, meta]) => meta.dedicatedPage && !islandCounts[id])
  .map(([id, meta]) => ({
    id,
    count: null,
    ...meta
  }))

const activeIslands = [...postBasedIslands, ...dedicatedIslands]
---

<Layout title="Territories - Map the Wild">
  <main class="relative z-10 max-w-2xl mx-auto px-6 py-16 md:py-24">
    <Breadcrumbs
      items={[
        { label: 'Home', href: '/mapthewild/' },
        { label: 'Territories' }
      ]}
    />

    <h1 class="text-3xl md:text-4xl font-display text-ink mb-4">
      Territories
    </h1>
    <p class="text-ink-muted mb-12">
      Different zones for different kinds of thinking.
    </p>

    <div class="space-y-4">
      {activeIslands.map((island) => (
        <a
          href={`/mapthewild/islands/${island.id}`}
          class="territory-item"
        >
          <h2 class="territory-item-title">
            {island.name}
            {island.count !== null && (
              <span class="territory-item-count">({island.count})</span>
            )}
          </h2>
          <p class="territory-item-description">{island.description}</p>
        </a>
      ))}
    </div>
  </main>
</Layout>

<style>
  /* Territory items with verdigris border (navigation accent) */
  .territory-item {
    display: block;
    padding: var(--space-lg);
    background: var(--color-white);
    border-radius: var(--radius-lg);
    border-left: 3px solid var(--color-verdigris);
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
  }

  .territory-item:hover {
    transform: translateX(4px);
    background: rgba(45, 106, 106, 0.05);
    box-shadow: var(--shadow-hover);
  }

  .territory-item-title {
    font-size: 22px;
    font-family: 'Fraunces', Georgia, serif;
    font-variation-settings: 'WONK' 1, 'SOFT' 50;
    color: var(--color-ink);
    margin-bottom: var(--space-sm);
    transition: color 0.2s;
  }

  .territory-item:hover .territory-item-title {
    color: var(--color-verdigris);
  }

  .territory-item-count {
    font-size: 16px;
    font-weight: normal;
    color: var(--color-ink-muted);
    margin-left: var(--space-sm);
  }

  .territory-item-description {
    font-size: 15px;
    color: var(--color-ink-light);
    line-height: 1.6;
  }
</style>
