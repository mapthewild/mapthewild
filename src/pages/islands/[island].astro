---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import Breadcrumbs from '../../components/Breadcrumbs.astro'

const islandMeta: Record<string, { name: string; description: string }> = {
  map: {
    name: 'Map',
    description: 'Working things out — exploratory, unformed, questioning'
  },
  territory: {
    name: 'Territory',
    description: 'Developed work — established, complete, structured'
  },
  nowbrary: {
    name: 'Nowbrary',
    description: 'Living constellation of books'
  }
}

export async function getStaticPaths() {
  const posts = await getCollection('posts')
  const publishedPosts = posts.filter(post => !post.data.draft)

  // Get all unique islands
  const islands = new Set<string>()
  publishedPosts.forEach(post => {
    post.data.islands?.forEach(island => islands.add(island))
  })

  return Array.from(islands).map(island => ({
    params: { island },
    props: { island }
  }))
}

const { island } = Astro.props
const meta = islandMeta[island] || { name: island, description: '' }

const posts = await getCollection('posts')
const islandPosts = posts
  .filter(post => !post.data.draft && post.data.islands?.includes(island))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  })
}
---

<Layout title={`${meta.name} - Map the Wild`}>
  <main class="relative z-10 max-w-2xl mx-auto px-6 py-16 md:py-24">
    <Breadcrumbs
      items={[
        { label: 'Home', href: '/mapthewild/' },
        { label: 'Territories', href: '/mapthewild/islands' },
        { label: meta.name }
      ]}
    />

    <header class="mb-12">
      <h1 class="text-3xl md:text-4xl font-display text-ink mb-4">
        {meta.name} <span class="text-ink-muted">({islandPosts.length})</span>
      </h1>
      {meta.description && (
        <p class="text-xl text-ink-muted">{meta.description}</p>
      )}
    </header>

    <div class="space-y-4">
      {islandPosts.map((post, index) => {
        const colors = ['ochre', 'verdigris', 'sienna', 'rose'];
        const colorClass = colors[index % colors.length];
        return (
        <a
          href={`/mapthewild/posts/${post.slug}`}
          class={`post-item post-item-${colorClass}`}
        >
          <time class="post-item-date">
            {formatDate(post.data.date)}
          </time>
          <h2 class="post-item-title">
            {post.data.title}
          </h2>
          <p class="post-item-excerpt">
            {post.data.description}
          </p>
        </a>
        );
      })}
    </div>

    {islandPosts.length === 0 && (
      <p class="text-ink-muted">No posts in this territory yet.</p>
    )}
  </main>
</Layout>

<style>
  /* Hover items with colored left border - from design system */
  .post-item {
    display: block;
    padding: var(--space-lg);
    background: var(--color-white);
    border-radius: var(--radius-lg);
    border-left: 3px solid var(--color-ochre);
    box-shadow: var(--shadow-card);
    transition: all 0.2s ease;
    text-decoration: none;
    cursor: pointer;
  }

  .post-item:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-hover);
  }

  /* Color variants */
  .post-item-ochre { border-left-color: var(--color-ochre); }
  .post-item-ochre:hover { background: rgba(196, 160, 53, 0.05); }
  .post-item-ochre .post-item-title { color: var(--color-ochre); }
  .post-item-ochre:hover .post-item-title { color: var(--color-ochre-dark); }

  .post-item-verdigris { border-left-color: var(--color-verdigris); }
  .post-item-verdigris:hover { background: rgba(45, 106, 106, 0.05); }
  .post-item-verdigris .post-item-title { color: var(--color-verdigris); }

  .post-item-sienna { border-left-color: var(--color-sienna); }
  .post-item-sienna:hover { background: rgba(160, 62, 32, 0.05); }
  .post-item-sienna .post-item-title { color: var(--color-sienna); }

  .post-item-rose { border-left-color: var(--color-rose); }
  .post-item-rose:hover { background: rgba(201, 160, 160, 0.08); }
  .post-item-rose .post-item-title { color: var(--color-rose-dark); }

  .post-item-date {
    font-size: 13px;
    color: var(--color-ink-muted);
    display: block;
    margin-bottom: var(--space-sm);
  }

  .post-item-title {
    font-size: 18px;
    font-family: 'Fraunces', Georgia, serif;
    font-variation-settings: 'WONK' 1, 'SOFT' 50;
    margin-bottom: var(--space-sm);
    transition: color 0.2s;
  }

  .post-item-excerpt {
    font-size: 15px;
    color: var(--color-ink-light);
    line-height: 1.6;
  }
</style>
