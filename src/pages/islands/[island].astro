---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import Breadcrumbs from '../../components/Breadcrumbs.astro'

const islandMeta: Record<string, { name: string; description: string }> = {
  map: {
    name: 'Map',
    description: 'Working things out — exploratory, unformed, questioning'
  },
  territory: {
    name: 'Territory',
    description: 'Developed work — established, complete, structured'
  },
  nowbrary: {
    name: 'Nowbrary',
    description: 'Living constellation of books'
  }
}

export async function getStaticPaths() {
  const posts = await getCollection('posts')
  const publishedPosts = posts.filter(post => !post.data.draft)

  // Get all unique islands
  const islands = new Set<string>()
  publishedPosts.forEach(post => {
    post.data.islands?.forEach(island => islands.add(island))
  })

  return Array.from(islands).map(island => ({
    params: { island },
    props: { island }
  }))
}

const { island } = Astro.props
const meta = islandMeta[island] || { name: island, description: '' }

const posts = await getCollection('posts')
const islandPosts = posts
  .filter(post => !post.data.draft && post.data.islands?.includes(island))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  })
}
---

<Layout title={`${meta.name} - Map the Wild`}>
  <div class="min-h-screen bg-space">
    <div class="stars"></div>
    <div class="stars2"></div>
    <div class="stars3"></div>

    <main class="relative z-10 max-w-2xl mx-auto px-6 py-16 md:py-24">
      <Breadcrumbs
        items={[
          { label: 'Home', href: '/mapthewild/' },
          { label: 'Islands', href: '/mapthewild/islands' },
          { label: meta.name }
        ]}
      />

      <header class="mb-12">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
          {meta.name} <span class="text-gray-500">({islandPosts.length})</span>
        </h1>
        {meta.description && (
          <p class="text-xl text-gray-400">{meta.description}</p>
        )}
      </header>

      <div class="space-y-12">
        {islandPosts.map((post) => (
          <article class="group">
            <time class="text-sm text-gray-500 mb-2 block">
              {formatDate(post.data.date)}
            </time>
            <h2 class="text-2xl font-bold text-white mb-3 group-hover:text-gray-300 transition-colors">
              <a href={`/mapthewild/posts/${post.slug}`}>
                {post.data.title}
              </a>
            </h2>
            <p class="text-gray-400 leading-relaxed">
              {post.data.description}
            </p>
          </article>
        ))}
      </div>

      {islandPosts.length === 0 && (
        <p class="text-gray-500">No posts in this island yet.</p>
      )}
    </main>
  </div>
</Layout>

<style>
  .bg-space {
    background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
    overflow: hidden;
    position: relative;
  }

  .stars, .stars2, .stars3 {
    position: absolute;
    top: 0;
    left: 0;
    background: transparent;
  }

  .stars {
    width: 1px;
    height: 1px;
    box-shadow:
      1780px 1456px #FFF, 1547px 1060px #FFF, 1411px 1473px #FFF,
      351px 1061px #FFF, 1522px 1287px #FFF, 1530px 1651px #FFF,
      943px 1044px #FFF, 1561px 1246px #FFF, 1695px 1654px #FFF;
    animation: animStar 50s linear infinite;
  }

  .stars2 {
    width: 2px;
    height: 2px;
    box-shadow:
      779px 1041px #FFF, 1129px 1618px #FFF, 1018px 1502px #FFF,
      927px 1756px #FFF, 1443px 1873px #FFF, 505px 1167px #FFF;
    animation: animStar 100s linear infinite;
  }

  .stars3 {
    width: 3px;
    height: 3px;
    box-shadow:
      1351px 1413px #FFF, 641px 1264px #FFF, 226px 1686px #FFF,
      1698px 945px #FFF, 990px 1748px #FFF;
    animation: animStar 150s linear infinite;
  }

  @keyframes animStar {
    from { transform: translateY(0px); }
    to { transform: translateY(-2000px); }
  }
</style>
