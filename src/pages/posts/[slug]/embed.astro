---
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const publishedPosts = posts.filter(post => !post.data.draft);
  return publishedPosts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{post.data.title}</title>
    <style>
      /* Design System Tokens */
      :root {
        --color-parchment: #f5f0e6;
        --color-parchment-dark: #e8e3d9;
        --color-ink: #4a3f35;
        --color-ink-light: #6b5d4d;
        --color-ink-muted: #8a7a66;
        --color-grid: #b8a990;
        --color-ochre: #c4a035;
        --color-ochre-dark: #9a7f2a;
        --color-rose: #c9a0a0;
        --color-rose-dark: #8a6b6b;
        --color-verdigris: #2d6a6a;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 1.5rem;
        font-family: Georgia, 'Times New Roman', serif;
        background: var(--color-parchment);
        color: var(--color-ink-light);
        font-size: 15px;
        line-height: 1.7;
      }

      header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-grid);
      }

      time {
        font-size: 12px;
        color: var(--color-ink-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      h1 {
        font-size: 1.375rem;
        font-weight: 400;
        color: var(--color-ochre);
        margin: 0.5rem 0;
        line-height: 1.3;
      }

      .description {
        font-size: 15px;
        color: var(--color-ink-muted);
        margin-top: 0.5rem;
      }

      .prose p {
        margin: 0 0 1.25em 0;
      }

      .prose h2 {
        font-size: 1.125rem;
        font-weight: 400;
        color: var(--color-ink);
        margin: 2em 0 0.75em 0;
      }

      .prose h3 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--color-ink);
        margin: 1.5em 0 0.5em 0;
      }

      .prose ul, .prose ol {
        margin: 1em 0 1em 1.5em;
      }

      .prose li {
        margin-bottom: 0.5em;
      }

      .prose a {
        color: var(--color-ochre);
        text-decoration: none;
        border-bottom: 1px solid rgba(196, 160, 53, 0.4);
        transition: all 0.2s;
      }

      .prose a:hover {
        color: var(--color-ochre-dark);
        border-bottom-color: var(--color-ochre-dark);
      }

      .prose strong {
        color: var(--color-ink);
        font-weight: 600;
      }

      .prose em {
        font-style: italic;
      }

      .prose blockquote {
        border-left: 3px solid var(--color-rose);
        padding-left: 1em;
        margin: 1em 0;
        color: var(--color-ink-light);
        font-style: italic;
      }

      .prose code {
        background: var(--color-parchment-dark);
        padding: 2px 6px;
        border-radius: 3px;
        color: var(--color-ink);
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        font-size: 0.9em;
      }

      .prose pre {
        background: var(--color-ink);
        color: var(--color-parchment);
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
        margin: 1em 0;
      }

      .prose pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }

      /* Must be :global() because MDX content doesn't have Astro's scoped attributes */
      :global(.bracket-link) {
        color: var(--color-ochre);
        cursor: pointer;
        text-decoration: none;
        border-bottom: 1px dotted var(--color-ochre);
      }

      :global(.bracket-link:hover) {
        color: var(--color-ochre-dark);
        border-bottom-color: var(--color-ochre-dark);
      }

      .prose hr {
        border: none;
        border-top: 1px solid var(--color-grid);
        margin: 2em 0;
      }

      .prose img {
        border-radius: 6px;
        margin: 1em 0;
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <article>
      <header>
        <time>
          {post.data.date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>

        <h1>{post.data.title}</h1>

        {post.data.description && (
          <p class="description">
            {post.data.description}
          </p>
        )}
      </header>

      <div class="prose">
        <Content />
      </div>
    </article>
    <script is:inline>
      // Intercept clicks and send to parent for stacking panes
      document.addEventListener('click', (e) => {
        const target = e.target;

        // Handle bracket-link clicks
        if (target.classList && target.classList.contains('bracket-link')) {
          e.preventDefault();
          e.stopPropagation();

          const content = target.getAttribute('data-content');
          const trigger = target.getAttribute('data-trigger') || target.textContent;

          if (content && window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'stackingPanes:navigate',
              content: content,
              trigger: trigger,
            }, '*');
          }
          return;
        }

        // Handle regular anchor links
        const link = target.closest('a');
        if (!link) return;

        const href = link.getAttribute('href');
        if (!href) return;

        // Check if it's an internal post link
        if (href.startsWith('/mapthewild/posts/')) {
          e.preventDefault();
          const slug = href.replace('/mapthewild/posts/', '').replace(/\/$/, '');
          const title = link.textContent || slug;

          if (window.parent && window.parent !== window) {
            window.parent.postMessage({
              type: 'stackingPanes:navigate',
              content: slug,
              trigger: title,
            }, '*');
          }
        }
      });
    </script>
  </body>
</html>
